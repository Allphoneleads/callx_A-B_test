/*
 * This build file was auto generated by running the Gradle 'init' task
 * by 'nazeemn' at '18/5/15 2:08 PM' with Gradle 2.3
 */

buildscript {
    
    repositories {
        jcenter()
        mavenCentral()
    }
    
    dependencies {
        classpath 'org.springframework.boot:spring-boot-gradle-plugin:1.1.7.RELEASE'
        classpath 'org.flywaydb:flyway-gradle-plugin:3.0'
        classpath 'net.saliman:gradle-properties-plugin:1.4.2'
        classpath 'org.hidetake:gradle-ssh-plugin:1.1.5'
    }

}

// Application Plugins
apply plugin: 'spring-boot'
apply plugin: 'java'
apply plugin: 'flyway'
apply plugin: 'net.saliman.properties'
apply plugin: 'org.hidetake.ssh'

// Developer Plugins
apply plugin: 'eclipse'

mainClassName = 'com.allphoneleads.api.MainApplication'

sourceCompatibility = '1.7'
targetCompatibility = '1.7'

[compileJava, compileTestJava]*.options*.encoding = 'UTF-8'

jar {

    baseName = rootProject.name
    version = version

}


repositories {

    mavenLocal()
    mavenCentral()
    

}
sourceCompatibility = '1.7'
targetCompatibility = '1.7'

configurations {

    providedRuntime

}

dependencies {

    compile (
        'org.springframework.boot:spring-boot-starter-web:1.2.0.RELEASE',
        'org.springframework.boot:spring-boot-starter-actuator:1.2.0.RELEASE',
        'org.springframework.boot:spring-boot-starter-data-jpa:1.2.0.RELEASE',
        'org.springframework:spring-context-support:3.2.8.RELEASE',
        'org.springframework.boot:spring-boot-starter-security:1.2.0.RELEASE',
       //'org.springframework.cloud:spring-cloud-aws-context:1.0.2.RELEASE',
        'org.jadira.usertype:usertype.core:3.1.0.CR1',
        'joda-time:joda-time:2.3',
        'mysql:mysql-connector-java:5.1.32',
		'com.plivo:plivo-java:3.0.6',
		'org.apache.httpcomponents:httpclient:4.5',
		'commons-fileupload:commons-fileupload:1.3.1',
		'commons-io:commons-io:2.4',
		'org.apache.velocity:velocity:1.6.4',
		'com.sun.mail:javax.mail:1.5.4',
		'jaf:activation:1.0.2',
		'commons-beanutils:commons-beanutils:1.9.2',
		'com.amazonaws:aws-java-sdk:1.10.2',
		'com.ivona:ivona-speechcloud-sdk-java:0.3.0',
		'com.whalin:Memcached-Java-Client:3.0.2',
		'commons-pool:commons-pool:1.6')
		 
    
    providedRuntime (
        'org.springframework.boot:spring-boot-starter-tomcat:1.2.0.RELEASE'
    )

    testCompile (
        'org.springframework.boot:spring-boot-starter-test:1.2.0.RELEASE'
    )
    
 }
 
 flyway {
    url = datasourceURL
    user = datasourceUsername
    password = datasourcePassword
}   

remotes {
  dev {
    role 'webServers'
    host = '52.25.102.231'
    user = 'ubuntu'
    identity = file('E:/ppk_files/AllPhonesLead/api.ppk')
  }
}

ssh.settings {
  knownHosts = allowAnyHosts
  dryRun = false
  
}



task cleanApplicationProperties(type: Delete) {
  println 'cleanApplicationProperties'
  delete 'src/main/resources/application.properties','src/main/resources/logback.xml'
   
}

task addApplicationProperties(type: Copy) {
    println 'addApplicationProperties'
    requiredProperties "springApplicationName", "datasourceURL", "datasourceUsername", "datasourcePassword", "datasourceDriverClassName", "hibernateDialect"
    from 'gradle/templates'
    include 'application.properties','logback.xml'
    into 'src/main/resources'
    filter(org.apache.tools.ant.filters.ReplaceTokens, tokens: project.filterTokens)
}


task deploy(dependsOn: 'build')  {
  println 'stated'
  ssh.run {
  println 'inside run'
    session(remotes.dev) {
      println 'inside session'
      def result1 = executeSudo 'pwd'
      println result1
      println 'deploying jar file to /home/ubuntu'
      put from: 'E:/Git/AllPhoneLeads/server/allPhoneLeads/build/libs/allPhoneLeads.jar', into: '/home/ubuntu'
    //println 'killing all Java proccess'
    //executeBackground 'sudo killall -9 java', ignoreError: true
    //println 'removing old jar file'
    //executeSudo 'rm -rf /home/ubuntu/Java/allphoneleads-server/server/allPhoneLeads/build/libs/allPhoneLeads.jar'
    //println 'copy file to project destination folder'
    //executeSudo 'cp -r /home/ubuntu/allPhoneLeads.jar /home/ubuntu/Java/allphoneleads-server/server/allPhoneLeads/build/libs/'
    //println 'removing logs'
    //executeSudo 'rm -rf /var/log/apl/*'
     
      //println 'restarting the server'
      //executeSudo 'cd /home/ubuntu/Java/allphoneleads-server/server/allPhoneLeads/'
      //executeBackground 'java -XX:+HeapDumpOnOutOfMemoryError -jar build/libs/allPhoneLeads.jar &'
      println 'Done deployment'
      
     
    }
  }
}

addApplicationProperties.dependsOn cleanApplicationProperties
compileJava.dependsOn addApplicationProperties



